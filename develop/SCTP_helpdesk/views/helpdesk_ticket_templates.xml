<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <template
        id="portal_layout"
        name="Bố cục Portal: mục lục ticket"
        inherit_id="portal.portal_breadcrumbs"
        priority="40"
    >
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li
                t-if="page_name == 'ticket' or ticket"
                t-attf-class="breadcrumb-item #{'active ' if not ticket else ''}"
            >
                <a
                    t-if="ticket"
                    t-attf-href="/my/tickets?{{ keep_query() }}"
                >Ticket</a>
                <t t-else="">Ticket</t>
            </li>
            <li t-if="ticket" class="breadcrumb-item active text-truncate">
                <span t-field="ticket.name" />
            </li>
        </xpath>
    </template>

    <template
        id="portal_my_home"
        name="Portal Trang chủ: mục ticket (phối màu)"
        inherit_id="portal.portal_my_home"
        priority="40"
        customize_show="True"
    >
        <xpath expr="//div[@id='portal_common_category']" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="icon" t-value="'/SCTP_helpdesk/static/src/img/helpdesk_icon.svg'"/>
                <t t-set="title">Ticket</t>
                <t t-set="url" t-value="'/my/tickets'"/>
                <t t-set="placeholder_count" t-value="'ticket_count'"/>
            </t>

            <div class="ticket-theme d-flex justify-between align-center mt-16">
                <div></div>
                <form method="POST" t-attf-action="/new/ticket">
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                    <button name="create_new_ticket" type="action" class="btn btn-gradient">Tạo Ticket</button>
                </form>
            </div>
        </xpath>
    </template>

    <template id="portal_my_tickets" name="Ticket của tôi (phối màu)">
        <t t-call="portal.portal_layout">
            

            <!-- Searchbar (giữ nguyên) -->
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-call="portal.portal_searchbar">
                <t t-set="title">Ticket</t>
            </t>
            <!-- HERO -->
            <section class="ticket-theme ticket-hero full-bleed" style="margin-bottom: 30px">
                <div class="hero-inner">
                    <div class="hero-left">
                        <h1>Ticket</h1>
                        <p>Quản lý ticket của bạn — xem trạng thái, lịch sử, tập tin đính kèm.</p>
                    </div>
                    <form method="POST" t-attf-action="/new/ticket">
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                        <button name="create_new_ticket" type="action" class="btn btn-gradient">Tạo Ticket</button>
                    </form>
                </div>
            </section>
            <div class="ticket-theme mt-16">
                <t t-if="not grouped_tickets">
                    <div class="alert alert-warning" role="alert">
                        <p>Không tìm thấy ticket nào.</p>
                    </div>
                </t>
                <t t-call="SCTP_helpdesk.portal_ticket_list"/>
            </div>
        </t>
    </template>

    <template id="portal_ticket_list" name="Danh sách Ticket">
        <t t-if="grouped_tickets">
            <t t-call="portal.portal_table">
                <t t-foreach="grouped_tickets" t-as="tickets">
                    <div class="ticket-theme card-soft mb-16">
                        <t t-call="portal.portal_table">
                            <thead>
                                <tr>
                                    <th class="text-left">Người tạo</th>
                                    <th class="text-left">Số</th>
                                    <th t-if="groupby == 'none'">Tiêu đề</th>
                                    <th t-if="groupby == 'category'">
                                        <em class="text-muted">Ticket trong nhóm:</em>
                                        <span class="text-truncate" t-field="tickets[0].sudo().category_id.complete_name"/>
                                    </th>
                                    <th t-if="groupby == 'stage'">
                                        <em class="text-muted">Ticket trong giai đoạn:</em>
                                        <span class="text-truncate" t-field="tickets[0].sudo().stage_id.name"/>
                                    </th>
                                    <th t-if="groupby != 'category'">Danh mục hỗ trợ</th>
                                    <th t-if="groupby != 'stage'">Giai đoạn</th>
                                    <th>Ngày tạo</th>
                                    <th>Cập nhật giai đoạn gần nhất</th>
                                    <th>Ngày đóng</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="tickets" t-as="ticket">
                                    <tr>
                                        <td class="text-left"><span t-field="ticket.partner_id"/></td>
                                        <td class="text-left"><span t-esc="ticket.number"/></td>
                                        <td>
                                            <a t-attf-href="/my/ticket/#{ticket.id}?{{ keep_query() }}">
                                                <span t-field="ticket.name"/>
                                            </a>
                                        </td>
                                        <td t-if="groupby != 'category'"><span t-esc="ticket.category_id.complete_name"/></td>
                                        <td t-if="groupby != 'stage'">
                                            <span
                                                title="Giai đoạn hiện tại của ticket"
                                                t-attf-class="stage-badge {{ 'is-open' if (not ticket.unattended) and (not ticket.closed) else 'is-unattended' if ticket.unattended else 'is-closed' if ticket.closed else '' }}"
                                                t-esc="ticket.stage_id.name"
                                            />
                                        </td>
                                        <td><span t-field="ticket.create_date"/></td>
                                        <td><span t-field="ticket.last_stage_update"/></td>
                                        <td><span t-field="ticket.closed_date"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </t>
                    </div>
                </t>
            </t>
        </t>
    </template>

    <template id="portal_helpdesk_ticket_page" name="Giao diện Ticket Portal (phối màu)">
        <t t-call="portal.portal_layout">
            <t t-call="portal.portal_record_layout">
                <!-- Header -->
                <t t-set="card_header">
                    <section class="ticket-theme ticket-hero" style="border-radius:14px;">
                        <div class="hero-inner">
                            <div class="hero-left">
                                <h1 class="text-title" style="font-size:22px;">
                                    <span t-field="ticket.name"/>
                                    <small class="text-muted"> ( <span t-field="ticket.number"/> )</small>
                                </h1>
                                <p class="text-muted">Cập nhật gần nhất: <span t-field="ticket.last_stage_update" t-options='{"widget":"datetime"}'/></p>
                            </div>
                            <div>
                                <span
                                    t-field="ticket.stage_id.name"
                                    class="stage-badge"
                                    t-attf-class="stage-badge {{ 'is-open' if (not ticket.unattended) and (not ticket.closed) else 'is-unattended' if ticket.unattended else 'is-closed' if ticket.closed else '' }}"
                                    title="Giai đoạn hiện tại của ticket"
                                />
                            </div>
                        </div>
                    </section>
                </t>

                <!-- Body -->
                <t t-set="card_body">
                    <div class="ticket-theme mt-16">
                        <div class="row">
                            <div class="col-12 col-md-6 mb-16">
                                <div class="card-soft" style="padding:16px;">
                                    <div><strong>Ngày:</strong> <span t-field="ticket.create_date" t-options='{"widget":"datetime"}'/></div>
                                    <div class="mt-16"><strong>Danh mục hỗ trợ:</strong> <span t-field="ticket.category_id"/></div>
                                </div>
                            </div>
                            <div class="col-12 col-md-6 mb-16 text-right">
                                <div class="card-soft" style="padding:16px; text-align:left;">
                                    <div><strong>Cập nhật giai đoạn gần nhất:</strong> <span t-field="ticket.last_stage_update" t-options='{"widget":"datetime"}'/></div>
                                    <div t-if="ticket.closed_date" class="mt-16"><strong>Ngày đóng:</strong> <span t-field="ticket.closed_date" t-options='{"widget":"datetime"}'/></div>

                                    <div t-if="not ticket.closed_date" name="ticket_close_buttons" class="mt-16">
                                        <t t-foreach="closed_stages" t-as="stage">
                                            <form method="GET" t-attf-action="/ticket/close" style="display:inline;">
                                                <input type="hidden" name="ticket_id" t-attf-value="#{ticket.id}"/>
                                                <input type="hidden" name="stage_id" t-attf-value="#{stage.id}"/>
                                                <button class="btn btn-outline-primary" style="font-size:12px; padding:6px 10px; border-radius:999px;">
                                                    <span t-field="stage.name"/>
                                                </button>
                                            </form>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row" t-if="ticket.user_id or ticket.partner_id">
                            <div class="col-12 col-md-6 mb-16" t-if="ticket.user_id">
                                <div class="card-soft" style="padding:16px;">
                                    <strong>Người phụ trách</strong>
                                    <div class="row mt-16">
                                        <div class="col d-flex align-items-center flex-grow-0 pr-3">
                                            <img class="o_avatar o_portal_contact_img rounded" t-att-src="image_data_uri(ticket.user_id.avatar_1024)" alt="Contact"/>
                                        </div>
                                        <div class="col pl-md-0">
                                            <div t-esc="ticket.user_id" t-options='{"widget":"contact","fields":["name"]}'/>
                                            <a t-attf-href="mailto:{{ticket.user_id.email}}" t-if="ticket.user_id.email">
                                                <div t-esc="ticket.user_id" t-options='{"widget":"contact","fields":["email"]}'/>
                                            </a>
                                            <a t-attf-href="tel:{{ticket.user_id.phone}}" t-if="ticket.user_id.phone">
                                                <div t-esc="ticket.user_id" t-options='{"widget":"contact","fields":["phone"]}'/>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-md-6 mb-16" t-if="ticket.partner_id">
                                <div class="card-soft" style="padding:16px;">
                                    <strong>Khách hàng</strong>
                                    <div class="row mt-16">
                                        <div class="col d-flex align-items-center flex-grow-0 pr-3">
                                            <img class="o_avatar o_portal_contact_img rounded" t-att-src="image_data_uri(ticket.partner_id.avatar_1024)" alt="Contact"/>
                                        </div>
                                        <div class="col pl-md-0">
                                            <div t-field="ticket.partner_id" t-options='{"widget":"contact","fields":["name"]}'/>
                                            <a t-attf-href="mailto:{{ticket.partner_id.email}}" t-if="ticket.partner_id.email">
                                                <div t-field="ticket.partner_id" t-options='{"widget":"contact","fields":["email"]}'/>
                                            </a>
                                            <a t-attf-href="tel:{{ticket.partner_id.phone}}" t-if="ticket.partner_id.phone">
                                                <div t-field="ticket.partner_id" t-options='{"widget":"contact","fields":["phone"]}'/>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row" t-if="ticket.description or ticket.attachment_ids">
                            <div t-if="ticket.description" t-attf-class="col-12 col-lg-6 mb-16 {{'col-lg-6' if ticket.attachment_ids else 'col-lg-12'}}">
                                <div class="card-soft" style="padding:16px;">
                                    <div class="section-title">Mô tả</div>
                                    <div class="py-1 px-2 bg-100 small" t-field="ticket.description"/>
                                </div>
                            </div>
                            <div t-if="ticket.attachment_ids" t-attf-class="col-12 col-lg-6 {{'col-lg-6' if ticket.description else 'col-lg-12'}}">
                                <div class="card-soft" style="padding:16px;">
                                    <strong class="d-block mb-2">Tệp đính kèm</strong>
                                    <div class="row">
                                        <div t-attf-class="col {{'col-lg-6' if not ticket.description else 'col-lg-12'}}">
                                            <ul class="list-group">
                                                <a
                                                    class="list-group-item list-group-item-action d-flex align-items-center oe_attachments py-1 px-2"
                                                    t-foreach='ticket.attachment_ids' t-as='attachment'
                                                    t-attf-href="/web/content/#{attachment.id}?download=true&amp;access_token=#{attachment.access_token}"
                                                    target="_blank" data-no-post-process=""
                                                >
                                                    <div
                                                        class='oe_attachment_embedded o_image o_image_small mr-2 mr-lg-3'
                                                        t-att-title="attachment.name"
                                                        t-att-data-mimetype="attachment.mimetype"
                                                        t-attf-data-src="/web/image/#{attachment.id}/50x40?access_token=#{attachment.access_token}"
                                                    />
                                                    <div class='oe_attachment_name text-truncate'><t t-esc='attachment.name'/></div>
                                                </a>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </t>
            </t>

            <div class="ticket-theme mt-16">
                <h4 class="section-title">Lịch sử tin nhắn và trao đổi</h4>
                <t t-call="portal.message_thread">
                    <t t-set="object" t-value="ticket"/>
                    <t t-set="token" t-value="ticket.access_token"/>
                    <t t-set="pid" t-value="pid"/>
                    <t t-set="hash" t-value="hash"/>
                </t>
            </div>
        </t>
    </template>

    <template id="portal_create_ticket" name="Tạo Ticket">
        <t t-call="portal.portal_layout">
            <div class="ticket-new container">

                <section class="ticket-hero full-bleed">
                    <div class="hero-inner">
                        <div>
                            <span class="hero-badge">Ticket Hỗ trợ</span>
                            <h1 class="hero-title">Tạo mới Ticket Hỗ Trợ</h1>
                            <p class="hero-sub">Ghi rõ vấn đề, bước tái hiện &amp; ảnh/log kèm theo để đội ngũ xử lý nhanh hơn.</p>
                        </div>
                    </div>
                </section>

                <!-- ===== CARD ===== -->
                <div class="ticket-card">
                    <form action="/submitted/ticket" method="POST" class="form-horizontal" enctype="multipart/form-data" id="ticketForm">
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

                        <!-- Team -->
                        <div class="form-group" t-if="teams">
                            <div class="col-md-3 col-sm-4 col-label">
                                <label class="control-label required-dot" for="team">Bộ phận phụ trách</label>
                            </div>
                            <div>
                                <select class="form-control" id="team" name="team" t-att-required="ticket_team_id_required">
                                    <option value="">— Chọn team —</option>
                                    <t t-foreach="teams" t-as="team">
                                        <option t-attf-value="#{team.id}">
                                            <t t-esc="team.name"/>
                                        </option>
                                    </t>
                                </select>
                                <div class="hint">Chọn đúng team giúp điều phối nhanh hơn.</div>
                            </div>
                        </div>

                        <!-- Category -->
                        <div class="form-group">
                            <div class="col-md-3 col-sm-4 col-label">
                                <label class="control-label required-dot" for="category">Nhóm vấn đề</label>
                            </div>
                            <div>
                                <select class="form-control" id="category" name="category" t-att-required="ticket_category_id_required">
                                    <option value="">— Chọn vấn đề cần hỗ trợ —</option>
                                    <t t-foreach="categories" t-as="cat">
                                        <option t-attf-value="#{cat.id}">
                                            <t t-esc="cat.complete_name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>
                        </div>

                        <!-- Subject -->
                        <div class="form-group">
                            <div class="col-md-3 col-sm-4 col-label">
                                <label class="control-label required-dot" for="subject">Tiêu đề</label>
                            </div>
                            <div>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="subject"
                                    name="subject"
                                    placeholder="VD: POS không in hóa đơn, lỗi Odoo: KeyError 'kanban-box'"
                                    required="True"
                                    maxlength="100"
                                />
                                <div class="inline-meta">
                                    <span class="meta-chip">Tối đa 100 ký tự</span>
                                    <span class="meta-chip" id="subject_counter">0/100</span>
                                </div>
                            </div>
                        </div>

                        <!-- Attachment -->
                        <div class="form-group">
                            <div class="col-md-3 col-sm-4 col-label">
                                <label class="control-label" for="attachment">Tệp đính kèm</label>
                            </div>
                            <div>
                                <label class="btn btn-default btn-file col-md-12">
                                    <input
                                        class="form-control o_website_form_input"
                                        name="attachment"
                                        id="attachment"
                                        type="file"
                                        multiple="multiple"
                                        t-att-max_upload_size="max_upload_size"
                                    />
                                </label>
                                <div class="hint">
                                    Dung lượng tối đa:
                                    <strong><t t-esc="int(max_upload_size/1024/1024)"/></strong> MB (tổng các file).
                                </div>
                                <div id="attachment_information" style="display:none;" class="danger hint"/>
                                <div id="file_list" class="file-list" style="display:none;"/>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="form-group">
                            <div class="col-md-3 col-sm-4 col-label">
                                <label class="control-label required-dot" for="description">Mô tả chi tiết</label>
                            </div>
                            <div>
                                <textarea
                                    class="form-control"
                                    id="description"
                                    name="description"
                                    placeholder="Bước tái hiện, kỳ vọng, ảnh hưởng, mã lỗi/log &amp; đường dẫn màn hình (nếu có)…"
                                    required="True"
                                ></textarea>
                                <div class="hint">Càng cụ thể, xử lý càng nhanh.</div>
                            </div>
                        </div>

                        <!-- Submit -->
                        <div class="form-group">
                            <div class="col-md-offset-3 col-sm-offset-4 col-sm-8 col-md-7">
                                <button class="btn btn-success btn-lg" type="submit">Gửi Ticket</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </t>
    </template>
</odoo>
